name: Test and Coverage

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ main ]

jobs:
  test-coverage:
    runs-on: homelab-amd64
    container:
      image: gitea:3000/electronya/electronya-firm-builder:latest
      options: --network srv-network

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        path: embedded-services

    - name: Setup West workspace
      run: |
        # Create west workspace
        mkdir -p workspace
        cd workspace

        # Initialize west with Zephyr
        west init -m https://github.com/zephyrproject-rtos/zephyr --mr v4.3-branch

        # Update to get all modules
        west update

        # Copy embedded-services into the workspace as a module
        mkdir -p apps
        cp -r ../embedded-services apps/

        # Export Zephyr environment
        west zephyr-export

        # Set working directory for subsequent steps
        echo "WORKSPACE_DIR=$PWD" >> $GITHUB_ENV

    - name: Verify environment
      run: |
        cd workspace
        pwd
        ls -la
        echo "ZEPHYR_BASE: $ZEPHYR_BASE"
        which gcc
        gcc --version
        which ninja
        west --version
        ls -la apps/embedded-services

    - name: Run tests with Twister
      run: |
        cd workspace/apps/embedded-services
        west twister -T tests --coverage --gcov-tool /usr/bin/gcov

    - name: Display coverage summary
      run: |
        cd workspace/apps/embedded-services

        echo "=== Coverage Report ==="
        echo "HTML report available at: twister-out/coverage/index.html"

        # Find and display coverage summary from all test suites
        for coverage_file in twister-out/*/native_sim*/*/coverage.info; do
          if [ -f "$coverage_file" ]; then
            echo "Coverage for $(dirname $coverage_file):"
            lcov --summary "$coverage_file" --rc lcov_branch_coverage=1 || true
          fi
        done

    - name: Prepare artifacts
      if: always()
      run: |
        mkdir -p artifacts/test-results
        mkdir -p artifacts/coverage-report

        # Copy test results
        cp workspace/apps/embedded-services/twister-out/twister.json artifacts/test-results/ || true
        cp workspace/apps/embedded-services/twister-out/twister.xml artifacts/test-results/ || true
        cp workspace/apps/embedded-services/twister-out/twister_report.xml artifacts/test-results/ || true

        # Copy coverage report
        cp -r workspace/apps/embedded-services/twister-out/coverage/* artifacts/coverage-report/ || true

        echo "Artifacts prepared:"
        ls -la artifacts/test-results/
        ls -la artifacts/coverage-report/

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: artifacts/test-results/
        retention-days: 30

    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-report
        path: artifacts/coverage-report/
        retention-days: 30

    # - name: SonarQube Scan
    #   env:
    #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    #   run: |
    #     cd workspace/apps/embedded-services
    #     sonar-scanner \
    #       -Dsonar.projectKey=embedded-services \
    #       -Dsonar.sources=src \
    #       -Dsonar.tests=tests \
    #       -Dsonar.host.url=$SONAR_HOST_URL \
    #       -Dsonar.token=$SONAR_TOKEN \
    #       -Dsonar.c.coverage.reportPaths=twister-out/coverage/coverage.info
