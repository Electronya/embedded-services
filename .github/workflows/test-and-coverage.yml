name: Test and Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: embedded-services

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          git cmake ninja-build gperf ccache dfu-util \
          device-tree-compiler wget python3-dev python3-pip \
          python3-setuptools python3-tk python3-wheel xz-utils file \
          make gcc gcc-multilib g++-multilib libsdl2-dev libmagic1 \
          lcov

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install west and dependencies
      run: |
        pip3 install west

    - name: Initialize west workspace
      run: |
        west init -l embedded-services
        west update
        west zephyr-export
        pip3 install -r zephyr/scripts/requirements.txt

    - name: Download and install Zephyr SDK
      run: |
        wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.17.0/zephyr-sdk-0.17.0_linux-x86_64.tar.xz
        tar xf zephyr-sdk-0.17.0_linux-x86_64.tar.xz
        cd zephyr-sdk-0.17.0
        ./setup.sh -t x86_64-zephyr-elf -h -c

    - name: Set environment variables
      run: |
        echo "ZEPHYR_BASE=$PWD/zephyr" >> $GITHUB_ENV
        echo "ZEPHYR_SDK_INSTALL_DIR=$HOME/zephyr-sdk-0.17.0" >> $GITHUB_ENV

    - name: Build tests with coverage
      run: |
        cd embedded-services/tests/adcAcquisition/filter
        west build -b unit_testing -p auto -- -DCOVERAGE=ON

    - name: Run tests
      run: |
        cd embedded-services/tests/adcAcquisition/filter
        ./build/testbinary

    - name: Generate coverage report
      run: |
        cd embedded-services
        lcov --capture --directory tests/adcAcquisition/filter/build \
          --output-file coverage.info \
          --rc lcov_branch_coverage=1

        # Filter out test files and system includes
        lcov --remove coverage.info \
          '*/tests/*' \
          '*/zephyr/*' \
          '/usr/*' \
          --output-file coverage.info \
          --rc lcov_branch_coverage=1

        # List coverage summary
        lcov --list coverage.info --rc lcov_branch_coverage=1

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./embedded-services/coverage.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        verbose: true
