name: Test and Coverage

on:
  push:
    branches: [ '*' ]
  pull_request:
    branches: [ main ]

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    steps:
    - name: Free up disk space
      run: |
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache
        sudo docker system prune -af
        sudo apt-get clean
        df -h

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          git cmake ninja-build gperf python3-pip python3-setuptools \
          python3-wheel python3-venv gcc g++ lcov
        pip3 install --user PyYAML west

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Cache Zephyr
      uses: actions/cache@v4
      id: cache-zephyr
      with:
        path: |
          zephyr
          modules
        key: ${{ runner.os }}-zephyr-v4.3.0
        restore-keys: |
          ${{ runner.os }}-zephyr-

    - name: Clone Zephyr (if not cached)
      if: steps.cache-zephyr.outputs.cache-hit != 'true'
      run: |
        rm -rf zephyr modules
        git clone --depth 1 --branch v4.3.0 https://github.com/zephyrproject-rtos/zephyr.git
        pip3 install --user -r zephyr/scripts/requirements.txt

    - name: Setup Zephyr environment
      run: |
        echo "ZEPHYR_BASE=$PWD/zephyr" >> $GITHUB_ENV
        pip3 install --user -r zephyr/scripts/requirements.txt || true
        df -h

    - name: Build tests with coverage
      run: |
        cd tests/adcAcquisition/filter
        west build -b unit_testing -p auto -- \
          -DCOVERAGE=ON \
          -DCMAKE_BUILD_TYPE=MinSizeRel

    - name: Run tests
      run: |
        cd tests/adcAcquisition/filter
        ./build/testbinary

    - name: Generate coverage report
      run: |
        # Capture coverage
        lcov --capture --directory tests/adcAcquisition/filter/build \
          --output-file coverage.info \
          --rc lcov_branch_coverage=1 \
          --ignore-errors mismatch

        # Filter out test files and system includes
        lcov --remove coverage.info \
          '*/tests/*' \
          '*/zephyr/*' \
          '/usr/*' \
          --output-file coverage.info \
          --rc lcov_branch_coverage=1

        # List coverage summary
        lcov --list coverage.info --rc lcov_branch_coverage=1

        # Clean up build artifacts to save space
        rm -rf tests/adcAcquisition/filter/build/CMakeFiles
        rm -rf tests/adcAcquisition/filter/build/zephyr/CMakeFiles
        df -h

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        verbose: true
